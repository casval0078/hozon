<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カメラ撮影とFirebaseアップロード</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: Arial, sans-serif;
        }
        h1 {
            margin-bottom: 20px;
        }
        .title {
            font-size: 18px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>カメラ撮影とFirebaseアップロード</h1>
    <div class="title">現在のカメラの情報は表示されていません。</div>
    <canvas id="canvas" style="display: none;"></canvas>

    <script type="module">
        // Firebase設定
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getStorage, ref, uploadString } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDsK4imQ3uWcK7hyESo6hnDyQ96lsPNCZ8",
	 　 authDomain: "nou-no-circle.firebaseapp.com",
	 　 projectId: "nou-no-circle",
	 　 storageBucket: "nou-no-circle.appspot.com",
	 　 messagingSenderId: "756338805186",
	 　 appId: "1:756338805186:web:cb740e035ac611b5baae5b",
	 　 measurementId: "G-TWBV38P13D"
        };

        // Firebase初期化
        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);

        // カメラアクセス
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let videoStream;

        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                videoStream = stream;
            })
            .catch(err => {
                console.error('カメラアクセスエラー:', err);
            });

        // 画像をFirebase Storageにアップロード
        function uploadImage(dataURL) {
            const storageRef = ref(storage, `images/${Date.now()}.jpg`);
            uploadString(storageRef, dataURL, 'data_url')
                .then(snapshot => {
                    console.log('画像がアップロードされました。');
                })
                .catch(err => {
                    console.error('アップロードエラー:', err);
                });
        }

        // 1分ごとに撮影してアップロード
        setInterval(() => {
            if (videoStream) {
                const videoTracks = videoStream.getVideoTracks();
                const track = videoTracks[0];
                const imageCapture = new ImageCapture(track);
                imageCapture.grabFrame()
                    .then(imageBitmap => {
                        canvas.width = imageBitmap.width;
                        canvas.height = imageBitmap.height;
                        ctx.drawImage(imageBitmap, 0, 0, canvas.width, canvas.height);
                        const dataURL = canvas.toDataURL('image/jpeg');
                        uploadImage(dataURL);
                    })
                    .catch(err => {
                        console.error('画像キャプチャエラー:', err);
                    });
            }
        }, 60000); // 60000ミリ秒 = 1分
    </script>
</body>
</html>
